<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Three Steps to Forever üíç</title>
  <style>
    body {
      margin: 0;
      background: radial-gradient(circle, #12122a, #070712);
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: white;
      touch-action: none;
    }
    canvas {
      background: linear-gradient(#2a2a55, #1a1a40);
      border-radius: 18px;
      box-shadow: 0 0 50px rgba(0,0,0,0.8);
      max-width: 95vw;
      max-height: 70vh;
    }
    .hint {
      position: absolute;
      top: 10px;
      font-size: 14px;
      z-index: 10;
      text-shadow: 1px 1px 2px black;
      text-align: center;
      width: 100%;
    }
    .msg {
      position: absolute;
      top: 40px;
      color: #ffb3c1;
      font-size: 18px;
      font-weight: bold;
      z-index: 10;
      text-align: center;
      width: 100%;
    }
    #proposal-ui {
      position: absolute;
      background: rgba(15, 15, 35, 0.95);
      padding: 20px;
      border-radius: 20px;
      border: 3px solid #ff6b81;
      text-align: center;
      display: none;
      flex-direction: column;
      align-items: center;
      max-width: 85%;
      z-index: 100;
      box-shadow: 0 0 30px rgba(255, 107, 129, 0.6);
    }
    .p-btn {
      background: #ff6b81;
      border: none;
      color: white;
      padding: 10px 25px;
      font-size: 16px;
      font-weight: bold;
      border-radius: 50px;
      cursor: pointer;
    }

    /* Mobile Arrow Keys Styles */
    #mobile-controls {
      position: absolute;
      bottom: 20px;
      left: 20px;
      display: grid;
      grid-template-columns: repeat(3, 50px);
      grid-template-rows: repeat(2, 50px);
      gap: 5px;
      z-index: 200;
    }
    .ctrl-btn {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 24px;
      user-select: none;
      -webkit-user-select: none;
    }
    .ctrl-btn:active {
      background: #ff6b81;
      border-color: #ffb3c1;
    }
    #btn-up { grid-column: 2; }
    #btn-left { grid-column: 1; grid-row: 2; }
    #btn-down { grid-column: 2; grid-row: 2; }
    #btn-right { grid-column: 3; grid-row: 2; }

    #start-overlay {
      position: fixed;
      inset: 0;
      background: #070712;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      cursor: pointer;
    }
  </style>
</head>
<body>

<div id="start-overlay" onclick="startGame()">
    <h2>Tap to Start ‚ù§Ô∏è</h2>
</div>

<div class="hint" id="hint">Level 1: Walk to the right ‚ù§Ô∏è</div>
<div class="msg" id="msg"></div>

<div id="proposal-ui">
    <div id="proposal-text"></div>
    <div style="display:flex; gap:10px;">
        <button class="p-btn" onclick="sayYes()">Yes</button>
        <button class="p-btn" onclick="sayYes()">YESS</button>
    </div>
</div>

<canvas id="game" width="700" height="520"></canvas>

<div id="mobile-controls">
    <div class="ctrl-btn" id="btn-up">‚Üë</div>
    <div class="ctrl-btn" id="btn-left">‚Üê</div>
    <div class="ctrl-btn" id="btn-down">‚Üì</div>
    <div class="ctrl-btn" id="btn-right">‚Üí</div>
</div>

<audio id="bgm" src="music.mp3" loop></audio>
<audio id="weddingBgm" src="wedding.mp3" loop></audio>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const hintEl = document.getElementById("hint");
const msgEl = document.getElementById("msg");
const proposalUi = document.getElementById("proposal-ui");
const proposalText = document.getElementById("proposal-text");
const bgm = document.getElementById("bgm");
const weddingBgm = document.getElementById("weddingBgm");

// Assets
const girl = { down: [new Image(), new Image()], up: new Image(), left: [new Image(), new Image()], right: [new Image(), new Image()] };
girl.down[0].src = "pixelforwardsmile1.png"; girl.down[1].src = "pixelforwardsmile2.png";
girl.up.src = "pixelbacksmile.png";
girl.left[0].src = "pixelfacingsideleft.png"; girl.left[1].src = "pixelsidewaysleft.png";
girl.right[0].src = "pixelfacingsideright.png"; girl.right[1].src = "pixelsidewaysright.png";
const maleCharImg = new Image(); maleCharImg.src = "male_character.png";
const ringImg = new Image(); ringImg.src = "ring.png";

// Game State
const SIZE = 28;
let player = { x: 40, y: 260, dx: 0, dy: 0, speed: 1.5, dir: "down", frame: 0, tick: 0 };
let level = 1, resetting = false, showRing = false, accepted = false, walkTogether = false;
let hearts = [], fireworks = [];

// Level Data
const walls2 = [{x:180,y:0,w:20,h:420},{x:300,y:100,w:20,h:420},{x:420,y:0,w:20,h:320},{x:540,y:200,w:20,h:320},{x:240,y:380,w:200,h:20}];
const door2 = {x:660, y:200, w:20, h:120};
const walls3 = [{x:160,y:0,w:20,h:520},{x:360,y:0,w:20,h:300},{x:360,y:360,w:20,h:160}];
const box = {x:220, y:260, w:30, h:30}, sw = {x:440, y:260, w:40, h:40}, door3 = {x:660, y:200, w:20, h:120};
let d3o = false;
const walls4 = [{x:0, y:0, w:700, h:180},{x:0, y:340, w:700, h:180},{x:220, y:180, w:20, h:60},{x:220, y:300, w:20, h:40},{x:460, y:180, w:20, h:60},{x:460, y:300, w:20, h:40}];
const redZone4 = {x:0, y:180, w:220, h:160}, door4 = {x:680, y:210, w:20, h:100};
const maleCharacter = { x: 350, y: 240, w: 32, h: 48 };

// Audio Init
bgm.volume = 0.5;
weddingBgm.volume = 0.5;

function startGame() {
    document.getElementById("start-overlay").style.display = "none";
    bgm.play().catch(() => {});
}

// Arrow Key Logic for Mobile
const btns = {
    "btn-up": {dy: -1, dx: 0, dir: "up"},
    "btn-down": {dy: 1, dx: 0, dir: "down"},
    "btn-left": {dy: 0, dx: -1, dir: "left"},
    "btn-right": {dy: 0, dx: 1, dir: "right"}
};

Object.keys(btns).forEach(id => {
    const el = document.getElementById(id);
    const startMove = (e) => {
        if (accepted) return;
        e.preventDefault();
        player.dx = btns[id].dx;
        player.dy = btns[id].dy;
        player.dir = btns[id].dir;
    };
    const endMove = (e) => {
        e.preventDefault();
        player.dx = 0;
        player.dy = 0;
    };
    el.addEventListener("touchstart", startMove);
    el.addEventListener("touchend", endMove);
    el.addEventListener("mousedown", startMove);
    el.addEventListener("mouseup", endMove);
});

// Keyboard fallback
document.addEventListener("keydown", e => {
  if (accepted) return;
  if (["ArrowUp", "w"].includes(e.key)) { player.dy = -1; player.dir = "up"; }
  if (["ArrowDown", "s"].includes(e.key)) { player.dy = 1; player.dir = "down"; }
  if (["ArrowLeft", "a"].includes(e.key)) { player.dx = -1; player.dir = "left"; }
  if (["ArrowRight", "d"].includes(e.key)) { player.dx = 1; player.dir = "right"; }
});
document.addEventListener("keyup", e => {
  if (["ArrowUp","w","ArrowDown","s"].includes(e.key)) player.dy = 0;
  if (["ArrowLeft","a","ArrowRight","d"].includes(e.key)) player.dx = 0;
});

function sayYes() {
    proposalUi.style.display = 'none';
    accepted = true;
    msgEl.textContent = "YES! Forever and Always ‚ù§Ô∏è";
    for(let i=0; i<80; i++) hearts.push({x: Math.random()*canvas.width, y: Math.random()*-canvas.height, vy: Math.random()*1.5+0.5, size: Math.random()*15+10, symbol: Math.random()>0.5?"‚ù§Ô∏è":"üíñ"});
    setTimeout(() => { walkTogether = true; setInterval(() => { if(walkTogether) createFirework(Math.random()*canvas.width, Math.random()*canvas.height/2); }, 900); }, 1000);
}

function createFirework(x, y) {
    const colors = ['#ff6b81', '#ffffff', '#ffd700', '#ff9ff3', '#00d2ff'];
    const color = colors[Math.floor(Math.random()*colors.length)];
    for (let i=0; i<25; i++) fireworks.push({x:x, y:y, vx:(Math.random()-0.5)*5, vy:(Math.random()-0.5)*5, life:100, color:color});
}

function update() {
  if (resetting) return;
  if (walkTogether) {
      player.x += 0.5; maleCharacter.x += 0.5; player.dir = "right"; player.tick++;
      if (player.tick % 35 === 0) player.frame = (player.frame + 1) % 2;
  }
  let nx = player.x + (player.dx * player.speed);
  let ny = player.y + (player.dy * player.speed);

  // Level Logic (Collision, Door checks, etc)
  if (level === 2) {
    for (const w of walls2) if (hit({x:nx,y:ny}, w)) { 
        resetting = true; msgEl.textContent = "Watch out! üíû";
        setTimeout(() => { msgEl.textContent = ""; player.x = 40; player.y = 260; resetting = false; }, 800);
        return; 
    }
  }
  if (level === 3) {
    for (const w of walls3) if (hit({x:nx,y:ny}, w)) return;
    if (hit({x:nx,y:ny}, box)) {
      const bx = box.x + (player.dx * player.speed), by = box.y + (player.dy * player.speed);
      let blocked = false;
      for (const w of walls3) if (hit({x:bx,y:by}, w)) blocked = true;
      if (!blocked) { box.x = bx; box.y = by; } else return;
    }
  }
  if (level === 4) {
    for (const w of walls4) if (hit({x:nx,y:ny}, w)) return;
    if (hit({x:nx,y:ny}, redZone4)) {
        resetting = true; msgEl.textContent = "Try again! :)";
        setTimeout(() => { msgEl.textContent = ""; player.x = 330; player.y = 260; resetting = false; }, 800);
        return;
    }
    if (hit({x:nx,y:ny}, door4)) { level = 5; hintEl.textContent = "Something is waiting... ‚ù§Ô∏è"; player.x = 100; player.y = 260; }
  }
  if (level === 5 && !accepted) {
      const dist = Math.hypot(player.x - maleCharacter.x, player.y - maleCharacter.y);
      if (dist < 80 && !showRing) {
          showRing = true; bgm.pause(); weddingBgm.play().catch(() => {});
          proposalUi.style.display = 'flex';
          proposalText.textContent = "Sejak kamu hadir dalam hidupku, semuanya terasa lebih bermakna. Kamu adalah kebahagiaanku. Maukah kamu memilihku seperti aku selalu memilihmu?";
      }
  }
  if (!accepted) {
    player.x = nx; player.y = ny;
    player.x = Math.max(0, Math.min(canvas.width-SIZE, player.x));
    player.y = Math.max(0, Math.min(canvas.height-SIZE, player.y));
    if (player.dx !== 0 || player.dy !== 0) { player.tick++; if (player.tick % 25 === 0) player.frame = (player.frame + 1) % 2; }
  }
  if (level === 1 && player.x > canvas.width - 40) { level = 2; hintEl.textContent = "Level 2: Navigation ‚ù§Ô∏è"; player.x = 40; player.y = 260; }
  if (level === 2 && hit(player, door2)) { level = 3; hintEl.textContent = "Level 3: Teamwork üíû"; player.x = 190; player.y = 260; }
  if (level === 3 && hit(box, sw)) { d3o = true; if (hit(player, door3)) { level = 4; hintEl.textContent = "Level 4: Intuition üí≠‚ù§Ô∏è"; player.x = 330; player.y = 260; } }
  hearts.forEach(h => { h.y += h.vy; if (h.y > canvas.height) h.y = -20; });
  fireworks.forEach((f, i) => { f.x += f.vx; f.y += f.vy; f.life--; if (f.life <= 0) fireworks.splice(i, 1); });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  if (level === 2) { ctx.fillStyle = "rgba(255,255,255,0.1)"; walls2.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h)); ctx.fillStyle = "#ff6b81"; ctx.fillRect(door2.x, door2.y, door2.w, door2.h); }
  if (level === 3) { ctx.fillStyle = "rgba(255,255,255,0.1)"; walls3.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h)); ctx.fillStyle = "#c49a6c"; ctx.fillRect(box.x, box.y, box.w, box.h); ctx.fillStyle = d3o ? "#88ffcc" : "#555"; ctx.fillRect(sw.x, sw.y, sw.w, sw.h); ctx.fillStyle = "#ff6b81"; ctx.fillRect(door3.x, door3.y, door3.w, door3.h); }
  if (level === 4) { ctx.fillStyle = "rgba(200, 30, 60, 0.2)"; ctx.fillRect(redZone4.x, redZone4.y, redZone4.w, redZone4.h); ctx.fillStyle = "rgba(255,255,255,0.1)"; walls4.forEach(w => ctx.fillRect(w.x, w.y, w.w, w.h)); ctx.fillStyle = "#ff6b81"; ctx.fillRect(door4.x, door4.y, door4.w, door4.h); }
  if (level === 5) { ctx.drawImage(maleCharImg, maleCharacter.x, maleCharacter.y, maleCharacter.w, maleCharacter.h); if (showRing && !walkTogether) { let pulse = Math.sin(Date.now() / 200) * 15 + 15; ctx.save(); ctx.shadowBlur = pulse; ctx.shadowColor = "#ffffff"; ctx.drawImage(ringImg, maleCharacter.x - 20, maleCharacter.y + 10, 22, 22); ctx.restore(); } }
  hearts.forEach(h => { ctx.font = `${h.size}px Arial`; ctx.fillText(h.symbol, h.x, h.y); });
  fireworks.forEach(f => { ctx.fillStyle = f.color; ctx.globalAlpha = f.life / 100; ctx.fillRect(f.x, f.y, 4, 4); });
  ctx.globalAlpha = 1;
  let img = girl.down[0];
  if (player.dir === "down") img = girl.down[player.frame];
  else if (player.dir === "up") img = girl.up;
  else if (player.dir === "left") img = girl.left[player.frame];
  else if (player.dir === "right") img = girl.right[player.frame];
  ctx.drawImage(img, player.x, player.y, SIZE, SIZE);
}

function hit(a, b) { return (a.x < b.x + b.w && a.x + SIZE > b.x && a.y < b.y + b.h && a.y + SIZE > b.y); }
function loop() { update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>